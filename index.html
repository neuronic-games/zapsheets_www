<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv='cache-control' content='no-cache'>
  <meta http-equiv='expires' content='0'>
  <meta http-equiv='pragma' content='no-cache'>
  <!-- <meta http-equiv="EXPIRES" content="Sat, 27 July 2024 11:00:00 GMT" /> -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Map</title>
  <link rel="stylesheet" href="./css/bootstrap.min.css"
    integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous" />
  <!-- <link rel="stylesheet" href="css/style.css"/> -->
  <link rel="icon" type="image/x-icon" href="./images/icon_map.png" />
  <link rel="apple-touch-icon" href="./images/maps.webp" />
  <link rel="manifest" href="./manifest.json?version=1">
</head>

<script src="./js-package/bootstrap.bundle.min.js"
    integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
    crossorigin="anonymous"></script>
 <script src="./js-package/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script src="./slick/slick.js"></script>
<script src="./js-package/moment.min.js"
  integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ=="
  crossorigin="anonymous"></script>
<script src="./js-package/popper.min.js"
  integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
  crossorigin="anonymous"></script>
<script src="./js-package/bootstrap.min.js"
  integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
  crossorigin="anonymous"></script>

<script src="./js-package/qrcode.min.js"></script>

<!-- New Preloader-->
<script src="./js-package/jquery.loading-indicator.min.js"></script>

<body class="page_greek d-flex flex-column min-vh-100">
  <div id="defaultScreen" style="position: relative; width: 100vw; height: 100vh; display: flex;
      flex-direction: column; align-items: center; justify-content: space-around;">
    <img  src="./images/icon_map.png?version=1.0" style="position:relative; width:15vh;"  alt="" onContextMenu="return false;" >
  </div>
  <div id="uiSnippetContainer" style="position: absolute; width: 100%; height: 100vh;"></div>

  <script src="./js-package/localdata.js"></script>
  <script src="./js-package/moment.min.js?version=1.0"></script>
  <script src="./js-package/device-uuid.min.js?version=1.0"></script>
  <script src="./js-package/md5.js?version=1.0"></script>
  <script src="./js-package/createjs.min.js?version=1.0"></script>
  <script>
      let isSWExists = false;
      let uiSpinnetLoaded = false;
      let localVersion = 0;
      let UIVersion = 0;
      let versionLoaded = false
      let iconDisplayed = false
      let activeSheetId = ''
      let activeKiosk = ''
      //////////////////////////////////////////////////////////////////////////////
      // Get unique number using time stamp
      function getUniqueNumber() {
        const now = new Date();
        const timestamp = now.getTime(); // Get the timestamp in milliseconds
        return timestamp;
      }
      //////////////////////////////////////////////////////////////////////////////
      // Load uiSnippet html
      // Checking Cors issues
      const loadSnippet = async (_ver) => {
        //alert(_ver, " SNIPP")
      const res = await fetch('./uiSnippetMap.html?version=' + _ver, {
        method: 'GET',
        mode: 'cors',
        headers: {
          'Content-Type': 'application/json'
        },
      }).then(res => {
        if(res.ok) {
          return res.text()
        }
      }).then(htmlSnippet => {

        document.getElementById('uiSnippetContainer').innerHTML = htmlSnippet
        uiSpinnetLoaded = true;

        //alert(activeSheetId)
        // Loading updated Controller
        getControllerVersion(_ver)

        // Hide default screen
        setTimeout(function() {
          document.getElementById('defaultScreen').style.display = 'none'
          //document.getElementById('preloaderCircle').style.display = 'block';

          // Show New Loader
          homeLoader = $('#preLoader').loadingIndicator({
            useImage: false,
          }).data("loadingIndicator");
          
          // Events
          document.getElementById('loaderPre').addEventListener('touchstart', onSplashDown)
          document.getElementById('loaderPre').addEventListener('mousedown', onSplashDown)
          document.getElementById('loaderPre').addEventListener('touchend', onSplashUp)
          document.getElementById('loaderPre').addEventListener('mouseup', onSplashUp)
        }, 300)
        
        //document.getElementById('loaderPre').style.display = 'none';
        /* document.getElementById('bottomLogos').style.display = 'flex';
        document.getElementById('preloaderCircle').style.display = 'block';
        document.getElementById('loadingText').style.display = 'block';

        if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
          document.getElementById('bottomLogos').style.setProperty("height","98vh");
          document.getElementById('preloaderCircle').style.setProperty("top","79vh");
          document.getElementById('loadingText').style.setProperty("top","81vh");
          document.getElementById('noConnectionStart').style.setProperty("top","27vh");
        } */
        
        const registerServiceWorker = async () => {
          if ("serviceWorker" in navigator) {
            try {
              const registration = await navigator.serviceWorker.register("./sw_map.js?version=" + _ver, {
                scope: "",
              });
              if (registration.installing) {
                isSWExists = false
              } else if (registration.waiting) {
                isSWExists = false
              } else if (registration.active) {
                isSWExists = true
              }
            } catch (error) {
              console.error(`Registration failed with ${error}`);
            }
          }
        };
        registerServiceWorker();
        if(window.navigator.onLine == true) {
          CheckNetConnection();
          //document.getElementById('debugText').innerHTML = 'Checking version from server </br>'
        } else {
          //document.getElementById('debugText').innerHTML = 'Checking version from local cache </br>'
          document.getElementById('slowConnectionStart').src = './images/conn_no_new.png?version=' + UIVersion
          document.getElementById('slowConnectionStart').style.display = 'block'
        }
        // Checking internet speed
        function CheckNetConnection() {
          if(window.navigator.onLine == true) {
            var netStartTime = new Date().getTime();
            var img = new Image();
            img.onload = function() {
              var netLoadTime = new Date().getTime() - netStartTime;
              checkConnectionSpeed(netLoadTime);
            }
            img.src = "./images/earshot-games_splash.png?version=" + Math.random()
          }
        }
        function checkConnectionSpeed(milliseconds) {
          if(window.navigator.onLine == true) {
            let downloadSize = 399000; //1024 * 1024 * 5;
            var duration = (milliseconds) / 1000;
            var bitsLoaded = downloadSize * 8;
            var bps = (bitsLoaded / duration).toFixed(2);
            var kbps = (bps / 1024).toFixed(2);
            var mbps = (kbps / 1024).toFixed(2);
            document.getElementById('slowConnectionStart').style.display = 'block'
            //console.log(mbps, " milliseconds")
            //milliseconds = 1100
            if(milliseconds > 3000) {
              iconDisplayed = true
              document.getElementById('slowConnectionStart').src = './images/conn_slow_new.png?version=' + UIVersion
              document.getElementById('slowConnectionStart').style.display = 'block'
              //document.getElementById('debugText').innerHTML += 'Internet Speed ' + mbps + 'mbps [SLOW]</br>' 
            } else if(milliseconds > 1000) {
              iconDisplayed = true
              document.getElementById('slowConnectionStart').src = './images/conn_moderate_new.png?version=' + UIVersion
              document.getElementById('slowConnectionStart').style.display = 'block'
              //document.getElementById('debugText').innerHTML += 'Internet Speed ' + mbps + 'mbps [MODERATE]</br>'
            } else {
              //document.getElementById('debugText').innerHTML += 'Internet Speed ' + mbps + 'mbps [GOOD]</br>'
              document.getElementById('slowConnectionStart').src = './images/conn_good_new.png?version=' + UIVersion
              document.getElementById('slowConnectionStart').style.display = 'block'
            }
          } 
        }
      })
    }
    /////////////////////////////////////////////////////////////////////////////////
    function loadInternetSettings(_ver) {
      var inetScript = document.createElement('script');
      inetScript.id = 'inet_Script';
      inetScript.type = 'text/javascript';
      inetScript.src = './js-package/getInternetStat.js?version=' + _ver;
      document.getElementsByTagName('head')[0].appendChild(inetScript);
    }
    /////////////////////////////////////////////////////////////////////////////////
    /*
    * getControllerVersion
    */
    function getControllerVersion(_ver) {
      var conScript = document.createElement('script');
      conScript.id = 'controller_Script';
      conScript.type = 'text/javascript';
      conScript.src = './js-package/JSController.js?version=' + _ver;
      document.getElementsByTagName('head')[0].appendChild(conScript);
    }
    /////////////////////////////////////////////////////////////////////////////////
    /*
    * getLatestGameCSSFile
    */
    function getLatestMapCSSFile(_ver) {
      let cssLink = document.createElement('link');
      cssLink.rel = 'stylesheet';
      cssLink.type = 'text/css';
      cssLink.href = './css/style.css?version=' + _ver;
      document.getElementsByTagName('head')[0].appendChild(cssLink);
    }
    //////////////////////////////////////////////////////////////////////////
    /*
    * onSplashDown
    */
    function onSplashDown(event) {
      event.preventDefault();
      //console.log("DOWN")
      isToggle = true;
      document.getElementById('mainAppContainer').style.display = 'none';
      document.getElementById('eventScreen').style.display = 'none';
      document.getElementById('defaultBG').style.display = 'none'
      document.getElementById('page-header').style.display = 'block'
      document.getElementById('page-footer').style.display = 'block'
      document.getElementById('spinningLoader').style.display = 'block'
      document.getElementById('loadingScreenImg').style.display = 'block'
      document.getElementById('loadingTxt').style.display = 'block'
      document.getElementById('versionText').style.display = 'none'
      document.getElementById('loadingTxt').style.zIndex = '99999999'
      document.getElementById('loadingTxt').style.backgroundColor = 'white'
      document.getElementById('loadingScreenImg').style.display = 'none'

      //document.getElementById('slowConnectionStart').style.display = 'none'
    }
    //////////////////////////////////////////////////////////////////////////
    /*
    * onSplashUp
    */
    function onSplashUp(event) {
      event.preventDefault();
      //console.log("UP")
      isToggle = false;
      document.getElementById('defaultBG').style.display = 'block'
      document.getElementById('page-header').style.display = 'none'
      document.getElementById('page-footer').style.display = 'none'
      document.getElementById('spinningLoader').style.display = 'block'
      document.getElementById('loadingScreenImg').style.display = 'flex'
      document.getElementById('loadingTxt').style.display = 'block'
      document.getElementById('loadingTxt').style.zIndex = '0'
      document.getElementById('versionText').style.display = 'block'
      document.getElementById('loadingTxt').style.backgroundColor = 'transparent'
      document.getElementById('loadingScreenImg').style.display = 'block'

      /* if(iconDisplayed) {
        document.getElementById('slowConnectionStart').style.display = 'block'
      } else {
        document.getElementById('slowConnectionStart').style.display = 'none'
      } */

      if(appDataLoaded) { 
        document.getElementById('slowConnectionStart').style.display = 'none'
        enableAppScreen(); 
      }
    }
    //////////////////////////////////////////////////////////////////////////
    function getUrlVars() {
      var vars = [], hash;
      var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
      for (var i = 0; i < hashes.length; i++) {
      hash = hashes[i].split('=');
      vars.push(hash[0]);
      vars[hash[0]] = hash[1];
      }
      return vars;
    } 
    //////////////////////////////////////////////////////////////////////////
    setTimeout(function() {
      //let s_Id = (getUrlVars()["id"]) ? getUrlVars()["id"].split('/')[0] : '';
      //let k_Num = (getUrlVars()["kiosk"]) ? getUrlVars()["kiosk"].split('/')[0] : '1';
      if(window.ldb != undefined) {
        window.ldb.get('mapUIVersion', function (value) {
          if(navigator.onLine == true) {
            UIVersion = getUniqueNumber();
            window.ldb.set('mapUIVersion', UIVersion)
            getLatestMapCSSFile(UIVersion)
            loadSnippet(UIVersion)
          } else {
            UIVersion = value
            getLatestMapCSSFile(UIVersion)
            loadSnippet(UIVersion)
          }
        })
      } else {
        UIVersion = getUniqueNumber();
        window.ldb.set('mapUIVersion', UIVersion)
        getLatestMapCSSFile(UIVersion)
        loadSnippet(UIVersion)
      }
    }, 3000)
    //////////////////////////////////////////////////////////////////////////
  </script>
</body>
</html> 


